<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Journal Club Topic Voting</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-align: center;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .topic-item {
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .topic-item:hover {
            border-color: #3498db;
            box-shadow: 0 5px 15px rgba(52,152,219,0.1);
        }
        
        .topic-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.1em;
        }
        
        .voting-options {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .vote-option {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 25px;
            transition: all 0.3s ease;
            background: #f8f9fa;
            border: 2px solid transparent;
        }
        
        .vote-option:hover {
            background: #e9ecef;
        }
        
        .vote-option.selected {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        input[type="radio"] {
            margin: 0;
        }
        
        .btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: block;
            margin: 30px auto 0;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52,152,219,0.3);
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .progress {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .results-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .score-high { background: #d5f4e6; }
        .score-medium { background: #fff3cd; }
        .score-low { background: #f8d7da; }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .success {
            background: #d5f4e6;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .instructions {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .instructions h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .vote-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            text-align: center;
            font-size: 0.9em;
        }
        
        .legend-score {
            font-weight: bold;
            color: #3498db;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Landing Page -->
        <div id="landing-page" class="page active">
            <div class="card">
                <h1>ðŸ§ª Journal Club Voting</h1>
                <p class="subtitle">Help us choose the most interesting topics for our upcoming journal club sessions!</p>
                
                <div class="instructions">
                    <h3>How it works:</h3>
                    <p>Rate each topic from 1-5 based on your interest level, or select "Unsure" if you're not familiar with the topic. Your votes will be combined with others to create a ranked list of the most popular topics.</p>
                </div>
                
                <div class="vote-legend">
                    <div class="legend-item">
                        <div class="legend-score">1</div>
                        <div>Not Interested</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-score">2</div>
                        <div>Slightly Interested</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-score">3</div>
                        <div>Moderately Interested</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-score">4</div>
                        <div>Very Interested</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-score">5</div>
                        <div>Extremely Interested</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-score">0</div>
                        <div>Unsure</div>
                    </div>
                </div>
                
                <button class="btn" onclick="startVoting()">Start Voting</button>
            </div>
        </div>
        
        <!-- Voting Page -->
        <div id="voting-page" class="page">
            <div class="card">
                <h1>Rate the Topics</h1>
                <div class="progress">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                <p id="progress-text" class="subtitle">0 of 36 topics rated</p>
                
                <div id="topics-container"></div>
                
                <button class="btn" id="submit-btn" onclick="submitVotes()" disabled>Submit Votes</button>
            </div>
        </div>
        
        <!-- Results Page -->
        <div id="results-page" class="page">
            <div class="card">
                <h1>ðŸ“Š Voting Results</h1>
                <p class="subtitle">Topics ranked by average interest score</p>
                
                <div id="results-container">
                    <div class="loading">Loading results...</div>
                </div>
                
                <button class="btn" onclick="goToVoting()">Vote Again</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Pasted from Firebase console
        const firebaseConfig = {
        apiKey: "AIzaSyCboKK0uSaUzyZt8VfxPUxu8JCIVkvJH68",
        authDomain: "journal-club-voting.firebaseapp.com",
        projectId: "journal-club-voting",
        storageBucket: "journal-club-voting.firebasestorage.app",
        messagingSenderId: "419653638368",
        appId: "1:419653638368:web:b3f57c2a90b166f860d885",
        measurementId: "G-MRRBFMBN7N"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Store globally for access from other functions
        window.db = db;
        window.addDoc = addDoc;
        window.collection = collection;
        window.getDocs = getDocs;
        window.query = query;
        window.orderBy = orderBy;
    </script>

    <script>
        const topics = [
            "Neural Network Potentials for Organic Chemistry",
            "Inverse Design of Molecular Libraries",
            "Machine-Learned Scoring Functions for Virtual Screening",
            "Reaction Representation Learning",
            "Low-Data / Multi-Task Learning in Chemistry",
            "Multi-Objective Optimization for Lead Discovery",
            "Uncertainty Quantification",
            "Measuring Kinetic Isotope Effects",
            "Deracemization Chemistry",
            "Transition State Search Methods",
            "Substrate scope or condition screening",
            "Computational Chemistry Methods for Exploring Chemical Reaction Networks",
            "Computer-Aided Retrosynthesis of Natural Products",
            "Flow Chemistry",
            "The Novelty Search Algorithm",
            "Transition State Theory",
            "Machine Learning for Excited State Molecules",
            "Retrieval-based/Retrieval-augmented Prediction for Chemistry",
            "Human-in-the-loop Workflow for Data-driven Predictive Chemistry",
            "Ligand Field Theory",
            "Chemistry Foundation Models",
            "Challenges in Molecule/Reaction Representations (and in their Implementations)",
            "Contrastive Learning on Molecular Graphs",
            "Bayesian Neural Networks",
            "Topological Deep Learning (applications to chemistry/biology)",
            "Machine Learning Prediction of Reaction Mechanisms",
            "Delta Learning for Computational Chemistry",
            "Batched Optimization",
            "Search, Tree Search, and Multi-Objective Tree Search",
            "Path Integral Molecular Dynamics",
            "ML-Enhanced Kinetic Monte Carlo",
            "LLM for Chemistry",
            "Metadynamics",
            "How DFT actually works",
            "Hamiltonian Learning via Deep Neural Networks",
            "Markov State Models Learned from High-Dimensional Trajectories"
        ];

        let votes = {};

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }

        function startVoting() {
            showPage('voting-page');
            renderTopics();
        }

        function renderTopics() {
            const container = document.getElementById('topics-container');
            container.innerHTML = '';

            topics.forEach((topic, index) => {
                const topicDiv = document.createElement('div');
                topicDiv.className = 'topic-item';
                topicDiv.innerHTML = `
                    <div class="topic-title">${topic}</div>
                    <div class="voting-options">
                        ${[1, 2, 3, 4, 5, 0].map(score => `
                            <label class="vote-option" data-topic="${index}" data-score="${score}">
                                <input type="radio" name="topic-${index}" value="${score}" onchange="recordVote(${index}, ${score})">
                                <span>${score === 0 ? 'Unsure' : score}</span>
                            </label>
                        `).join('')}
                    </div>
                `;
                container.appendChild(topicDiv);
            });
        }

        function recordVote(topicIndex, score) {
            votes[topicIndex] = score;
            updateProgress();
            
            // Update visual selection
            const topicItem = document.querySelectorAll('.topic-item')[topicIndex];
            const options = topicItem.querySelectorAll('.vote-option');
            options.forEach(option => {
                option.classList.remove('selected');
                if (parseInt(option.dataset.score) === score) {
                    option.classList.add('selected');
                }
            });
        }

        function updateProgress() {
            const votedCount = Object.keys(votes).length;
            const totalCount = topics.length;
            const percentage = (votedCount / totalCount) * 100;
            
            document.getElementById('progress-bar').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = `${votedCount} of ${totalCount} topics rated`;
            
            document.getElementById('submit-btn').disabled = votedCount < totalCount;
        }

        async function submitVotes() {
            try {
                document.getElementById('submit-btn').disabled = true;
                document.getElementById('submit-btn').textContent = 'Submitting...';

                const voteData = {
                    votes: votes,
                    timestamp: new Date(),
                    voterCount: 1
                };

                await window.addDoc(window.collection(window.db, 'votes'), voteData);
                
                showSuccess('Votes submitted successfully!');
                setTimeout(() => {
                    showPage('results-page');
                    loadResults();
                }, 1500);

            } catch (error) {
                console.error('Error submitting votes:', error);
                showError('Failed to submit votes. Please try again.');
                document.getElementById('submit-btn').disabled = false;
                document.getElementById('submit-btn').textContent = 'Submit Votes';
            }
        }

        async function loadResults() {
            try {
                const container = document.getElementById('results-container');
                container.innerHTML = '<div class="loading">Loading results...</div>';

                const votesSnapshot = await window.getDocs(window.collection(window.db, 'votes'));
                
                // Aggregate all votes
                const topicScores = {};
                const topicCounts = {};
                
                topics.forEach((topic, index) => {
                    topicScores[index] = 0;
                    topicCounts[index] = 0;
                });

                votesSnapshot.forEach(doc => {
                    const data = doc.data();
                    Object.entries(data.votes).forEach(([topicIndex, score]) => {
                        if (score > 0) { // Don't count "Unsure" votes in average
                            topicScores[topicIndex] += score;
                            topicCounts[topicIndex] += 1;
                        }
                    });
                });

                // Calculate averages and create results array
                const results = topics.map((topic, index) => ({
                    topic,
                    average: topicCounts[index] > 0 ? (topicScores[index] / topicCounts[index]).toFixed(2) : 'N/A',
                    voteCount: topicCounts[index],
                    rawAverage: topicCounts[index] > 0 ? topicScores[index] / topicCounts[index] : 0
                }));

                // Sort by average score
                results.sort((a, b) => b.rawAverage - a.rawAverage);

                // Render results table
                container.innerHTML = `
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Topic</th>
                                <th>Average Score</th>
                                <th>Vote Count</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.map((result, index) => {
                                let scoreClass = '';
                                if (result.rawAverage >= 4) scoreClass = 'score-high';
                                else if (result.rawAverage >= 3) scoreClass = 'score-medium';
                                else if (result.rawAverage > 0) scoreClass = 'score-low';
                                
                                return `
                                    <tr class="${scoreClass}">
                                        <td>${index + 1}</td>
                                        <td>${result.topic}</td>
                                        <td>${result.average}</td>
                                        <td>${result.voteCount}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;

            } catch (error) {
                console.error('Error loading results:', error);
                document.getElementById('results-container').innerHTML = 
                    '<div class="error">Failed to load results. Please try again.</div>';
            }
        }

        function goToVoting() {
            votes = {};
            showPage('voting-page');
            renderTopics();
            updateProgress();
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.card').appendChild(errorDiv);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.querySelector('.card').appendChild(successDiv);
            
            setTimeout(() => successDiv.remove(), 3000);
        }

        // Load results on page load if coming directly to results
        if (window.location.hash === '#results') {
            showPage('results-page');
            loadResults();
        }
    </script>
</body>
</html>